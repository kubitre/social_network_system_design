# System design социальной сети для путешественников

## Мотивация

Все мы любим путешествовать, но также мы любим делать снимки, отправлять их друзьям. Чтобы сделать это в едином пространстве, и дать возможность другим незнакомым людям, сделаем пространство для их взаимодейтсвия

## Неформальное описание задачи от бизнеса

- публикация постов из путешествий с фотографиями, небольшим описанием и привязкой к конкретному месту путешествия;
- оценка и комментарии постов других путешественников;
- подписка на других путешественников, чтобы следить за их активностью;
- поиск популярных мест для путешествий и просмотр постов с этих мест;
- просмотр ленты других путешественников и ленты пользователя, основанной на подписках в обратном хронологическом порядке;

Что касается будущей аудитории социальной сети - у бизнеса есть огромные средства для рекламы и продвижения социальной сети, поэтому пользовательская база будет постепенно линейно расти и предполагается, что через год достигнет примерно 10 000 000 уникальных пользователей в день, после чего также будет продолжать расти. 
Бизнес пока нацелен  только на аудиторию стран СНГ (на зарубежный рынок выходить планов нет). 
Будущая система должна быть очень надежной, а также, чтобы с ней было удобно взаимодействовать, используя мобильные устройства и браузер.

## Функциональные требования

1. Посты 
    Модель: Post (id, external_id, title, description, geo_tags, author_id, created_at, amount_likes) (решил сразу денормализовывать количество лайков вовнутрь поста(точностью количества лайков можно принебречь))
    
    Функции:
    - Создание поста с описанием и прикрепление картинок
    - Загрузка контента (бинарные данные). 
    - Прикрепить картинки к посту.
        Модель: PostImage(id, post_id, content_id)
    - Поставить лайк
        Модель: Like(id, user_id, post_id), отдельная сущность нужна для дедупликации реакции
    - Получение списка постов
        1) с фильтром по "моим" подпискам
        2) с фильтром по "популярности"
        3) с фильтром "мои"
        4) поиск по гео тегам (допустим на входе это будет строка):

2. Комментарии 
    Модель: Comment (id, external_id, text, author_id, created_at, amount_likes) (идентично денормализовал количество лайков как в случае с постами)
    
    Функции:
    - Создание комментариев 
    - Просмотр комментариев поста с пагинацией в хронологическом порядке
    - Поставить лайк 
         
3. Подписки пользователя
    Модель: Subscription(id, user_id, sub_user_id)
    Функции:
    - Создание подписки на пользователя
    - Удаление подписки?
    - Просмотр подписок?


## Нефункциональные требования

### Аудитория приложения

1. Количество активных пользовтелей в день (DAU) = 10_000_000

2. Поведение пользователей
    - Создание поста с описанием и прикрепление картинок
        Оценка: в среднем пользователи будут заводить 1-2 поста в неделю ~ 0.3 поста в день
    - Загрузка контента (бинарные данные). 
        Грузить будут в среднем не более 10 картинок (посчитаю по верхней планке). 
        Оценка: грубо говоря 20 картинок в неделю ~ 20/7 ~ 3 в день
    - Прикрепить картинки к посту.
        Оценка: Прикрепляться картинки будут пачкой, беру по максимальной границе - 10 штук, соответсвенно это будет происходить когда создается пост
    - Поставить лайк
        Оценка: Лайкать пользвоатели будут много, например 10 лайков в день

    - Получение списка постов
        Размер пачки порядка 15 постов 
        1) с фильтром по "моим" подпискам
            Пользователь заходя в приложение будет попадать на дефолтный список - мои подписки.
            С этим фильтром пользователь будет чаще всего приходить за списком, условно считаю, что где-то 2 раза в день. 
            Оценка: 2 запроса в день по 15 постов
        2) с фильтром по "популярности"
            Пользователь будет переключать тоглик, в запросе будет прилетать фильтр-флажок "популярное"
            С этим фильтром пользователь будет заходить допустим раз в день
            Оценка: 1 запрос в день по 15 постов
        3) с фильтром "мои"
            Пользователь будет переходить на свою страницу и на бекенд будет приходить фильтр-флажок "только мои"
            Пользвоатель будет редко заходить в свои собственные публикации, разве что когда будет создавать новые посты, поэтому примерно оценю по оценке с заведением новых постов 
            Оценка: 2 раза в неделю по 15 постов ~ 2/7 ~ 0.3 запроса в день
        4) поиск по гео тегу (допустим это будет строка):
            Допустим пользователь будет каждый вечер искать интересные места. В среднем Поисковых запросов в среднем будет 10
            Оценка: 10 запросов в день по 15 штук

2. Комментарии 
    Функции:
    - Создание комментариев 
        в среднем пользователь будет оставлять сильно меньше комментариев, чем лайков
        Оценка: 2 комментария в день
    - Просмотр комментариев поста с пагинацией в хронологическом порядке
        В среднем пользователь ежедневно будет открывать 10% первых постов и просматривать первую пачку
        Оценка: 2 пачки по 10 штук в день 
    - Поставить лайк 
        В среднем пользователи будут лайкать только первые пару комментариев в выданной пачке. ОДин пользователь как миниуму 1 комментарий в день оставит
        Оценка: 1 лайка в день
         
3. Подписки пользователя
    Функции:
    - Создание подписки на пользователя
        Создание подписок будет происходить в момент просмотра популярного контента, можно посчитать примерно по тому, сколько популярных постов просматривает пользователь. Предположим, что около 20% авторов заинтересуют пользователя (грубо говоря каждый популярный пост будет от уникального пользователя)
        Оценка: 5 запросов в неделю ~ 5/7 ~ 0.8 запросов в день
    - Удаление подписки?
        Пользователь в среднем будет отписываться 2 раза в месяц от неактивных пользователей, или от тех, кто перестал пользоваться
        Оценка: 5 запроса в месяц ~ 5/30 ~ 0.2 запроса в день
    - Просмотр подписок?
        Пользователь допустим будет обращаться к своим подпискам только тогда, когда будет проверять вероятно будет удалять из подписок кого-либо
        Оценка: 5 запроса в месяц ~ 5/30 ~ 0.2 запроса в день

3. Аудитория - СНГ

4. Клиентские устройства - мобилки\браузер 
    - Мобильным приложением будут пользоваться больше
    - т.к. мобильным приложением будут пользовать больше, могут быть обрывы чаще (например пользователь будет в метро ехать)
    - нужно учитывать идемпотеность методов (external_id завел там, где в основном нельзя как-то по другому дедупликацию сделать)

### Особенности приложения
1. Сезоннность в приложении
    - Люди обычно чаще путешствуют летом, поэтому вероятно летом будет нагрузка выше
    - Т.к. география приожения - СНГ, то охват будет большинства часовых поясов. Поэтому +- нагрузка по времени суток будет одинаковой

2. Данные храним всегда, либо можно как-то удалять \ семплировать какие-либо данные?
    1) Картинки
        - В нашем случае картинки можно скорее всего как-то сжимать, чтобы отдавать меньше данных по сети (допустим демоном после загрузки контента, будет создавать маленькие по размеру картинки и отдавать такое будем пользователю, также возможно можно сделать флажок "готовности" к показу поста, чтобы отдавать на запрос только тогда, когда сделаем CPU bound операции по сжатию картинок)
        - Сжатие картинок можно делать асинхронно после того, как данные попадут в наше хранилище.
        - Исходники картинок можно положить в хранилку с hdd например, для того, чтобы меньше платить за занимаемый объем
        - Сжатые картинки будем хранить идентично в долгой хранилке
        - картинки из популярных постов вероятнее всего лучше положить в более быстрое хранилище (например на ssd)

    2) Посты
        - будем хранить всегда
        - в целом зачастую отдача постов будет в хронологическом порядке, имеет смысл заранее продумать партицирование таблицы с постами (например будем нарезать по месяцам)
    3) Лайки 
        - как подмечал выше, можем семплировать и сохранять их в модели комментария\поста
        - Исходные записи о лайках нужно хранить всегда, т.к. нам нужно дедуплицировать лайк от пользователя
    4) Подписки пользователя
        - Нужно хранить всегда

3. Лимиты и ограничения 
    1) Картинки. 
        - Беру в расчет среднестатистический размер картинки на современных смартфонах ~ 5мб
        - Количество картинок под 1 постом будет не более 10 штук
        - Предположим что поддерживаем только несколько форматов картинок, например jpg,png,webp
    2) Пост
        - Предположим, что сверху мы не ограничиваем пользователя по количеству постов
        - В рамках запроса списка постов и поиска будем возвращать пачку из 15 постов, если нужно дозапросить больше, тогда прибегнем к пагинации
        - Количество символов которое можно будет вставить в описание поста ограничим сверху 5000 символами
        - В рамках поста можно будет указать сразу N тегов, но не более 10 штук
    3) Комментарий
        - можем сделать условно бесконечным количеством (но наврдя ли пользователи будут листать до конца всю пагинацию), поэтому оставим порядок 100
        - Количество комментариев в пачке на запрос получения списка коментариев к посту будет 10 штук
        - количество символов условно сделаем не более 200 в рамках комментария
    3) Подписки
        - Допустим делаем максимальное количество подписок на текущем этапе не более нашего макисмального количества DAU, например 10kk

4. Временные ограничения
    1) Получение картинок - не более 2-3 секунд на картинку 
        Т.к. выше принял тот факт, что делаем более сжатые картинки для показа, соответсвенно 1 такую картинку можно грузить (но тут зависит от того, каких пользователей больше будет, мобильных или браузерных. Десктопный интернет обычно стабильнее и шустрее, хотя сейчас в целом мобильный интернет местами не уступает)
    2) Загрузка картинки на сервер: не дольше 1 минуты
        пользователь может асинхронно загружать картинки, исходные картинки достаточно тяжелые, 5мб
    3) создание поста должно выполнятся за 1-2 секунды 
        - основное время все равно будет съедать загрузка контентов картинок
        - колчиество данных небольшое, прогнать по сети 
    4) Прикрепление картинок к посту: не более 1 секунды на запрос
        - контенты мы загрузили в рамках метода загрузки контента, сюда на вход прийдет немного данных, должно выполнятся быстрое
    5) Поставить лайк: не более 100-200мс
        - Пользвоатели могут скролить быстро, они не будут готовы ждать пока что-то обработается.
        - Денормализацию в пост\комментарий будет делать допустим по событиям из оплога нашей базы в фоне

5. Доступность приложения:
    - Простой приложения не больше нескольки часов в год, то есть доступность 99.95% 

## Расчет нагрузки

1. Функции связанные с постами:
    - создание поста:
        RPS = (10_000_000 * 0.3) / 86400 ~ 30 rps
        Traffic = 30 * 3.5kb ~ 100kb/s
        Connections = 10_000_000 * 0.1 ~ 1_000_000
    - Загрузка контента в систему:
        RPS = 10_000_000 * (10/7) / 86400 ~ 150 rps
        Traffic = 150 * 10mb = 1500mb/s
        Connections = 10_000_000 * 0.1 ~ 1_000_000 ?
    - Прикрепление картинок к посту:
        RPS ~ RPS (создание поста) ~ 20rps
        Traffic = 20 * 100b = 2kb/s
        Connections = 10_000_000 * 0.1 ~ 1_000_000 ?
    - Лайк поста: 
        RPS = 10_000_000 * 25 / 86400 ~ 2500 rps
        Traffic = 2500 * 100b = 250_000b/s ~ 250kb/s
        Connections = 10_000_000 * 0.1 ~ 1_000_000 ?
    - Подгрузка сжатых картинок при просмотре ленты:
        RPS = 10_000_000 * (10 * 10) / 100k ~ 10_000rps
        Traffic = 10_000 * 800kb ~ 8_000_000kb ~ 8mb/s
        Connections = 10_000_000 * 0.4 ~ 4_000_000 (взял коэфф побольше, т.к. просмотр по логике будет чаще использоваться)

    - Получение списка постов
        RPS (получение списка постов подписок) = 10_000_000 * 30 / 86400 ~ 3_000 rps 
        RPS (получнеие списка своих постов) = 10_000_000 * (1/7) / 86400 ~ 30 rps
        RPS (получение списка популярных постов) = 10_000_000 * 15 / 86400 ~ 1_500rps
        RPS (поиск постов по тегам) = 10_000_000 * (10) / 86400 ~ 1_000rps
        RPS (чтение ленты постов) ~ 6_000rps
        Traffic = 6_000 * (3.5kb * 15) ~ 300_000kb ~ 300mb/s
        Connection = 10_000_000 * 0.4 ~ 4_000_000 

2. Функции связанные с комментариями
    - создание комментария
        RPS = 10_000_000 * 2 / 86400 ~ 2_000 rps
        Traffic = 2_000 * 250b = 500_000b ~ 500kb/s
        Connections = 10_000_000 * 0.2 ~ 2_000_000 
    - получения списка комментариев
        RPS = 10_000_000 * 2 / 86400 ~ 2_000 rps
        Traffic = 2_000 * 250b = 500_000b ~ 500kb/s
        Connections = 10_000_000 * 0.2 ~ 2_000_000 
    - лайк комментария
        RPS = 10_000_000 * 1 / 86400 ~ 1_000 rps 
        Traffic = 1_000 * 250b = 500_000b ~ 500kb/s
        Connections = 10_000_000 * 0.2 ~ 2_000_000

3. Функции связанные с подписками пользователей
    - создание подписки
        RPS = 10_000_000 * 0.8 / 86400 ~ 800rps
        Traffic = 800 * 150b ~ 120_000b ~ 120kb
        Connections = 10_000_000 * 0.05 ~ 500_000
    - просмотр подписки 
        RPS = 10_000_000 * 0.8 / 86400 ~ 800rps
        Traffic = 800 * 150b ~ 120_000b ~ 120kb
        Connections = 10_000_000 * 0.05 ~ 500_000
